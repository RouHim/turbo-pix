# # # # # # # # # # # # # # # # # # # #
# FFmpeg Downloader
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
FROM alpine:latest AS ffmpeg-downloader

# Download and extract static ffmpeg build
RUN apk add --no-cache curl tar xz && \
    curl -L -o ffmpeg-release.tar.xz https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz && \
    tar xf ffmpeg-release.tar.xz && \
    mv ffmpeg-*-amd64-static/ffmpeg /ffmpeg && \
    mv ffmpeg-*-amd64-static/ffprobe /ffprobe && \
    chmod +x /ffmpeg /ffprobe && \
    rm -rf ffmpeg-* ffmpeg-release.tar.xz

# # # # # # # # # # # # # # # # # # # #
# Application Builder
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
FROM docker.io/messense/rust-musl-cross:x86_64-musl AS builder

# Set working directory and create empty directory in one layer
WORKDIR /app
RUN mkdir "/empty_dir"

# Copy source code
COPY ../Cargo.toml ./
COPY ../Cargo.lock ./
COPY ../src ./src
COPY ../static ./static

# Build application with musl compatibility
# Pre-fetch dependencies and patch sqlite-vec for musl (https://github.com/asg017/sqlite-vec/pull/199)
RUN cargo fetch --target x86_64-unknown-linux-musl && \
    find /root/.cargo/registry/src -name "sqlite-vec.c" -exec sed -i '/^typedef u_int8_t uint8_t;$/d; /^typedef u_int16_t uint16_t;$/d; /^typedef u_int64_t uint64_t;$/d' {} \;

RUN cargo build --release --target x86_64-unknown-linux-musl

# Download AI models for semantic search
ENV TURBO_PIX_DATA_PATH="/data"
RUN mkdir -p /data && \
    /app/target/x86_64-unknown-linux-musl/release/turbo-pix --download-models

# # # # # # # # # # # # # # # # # # # #
# Run image
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
FROM scratch
# Set environment variables in one layer
ENV USER="1000" \
    TURBO_PIX_PHOTO_PATHS="/photos" \
    TURBO_PIX_DATA_PATH="/data" \
    RUST_LOG="info" \
    FFMPEG_PATH="/ffmpeg" \
    FFPROBE_PATH="/ffprobe"

# For performance reasons write data to docker volume instead of containers writeable fs layer
VOLUME $TURBO_PIX_DATA_PATH

# Copy the data directory with pre-downloaded models
COPY --chmod=777 --chown=$USER:$USER --from=builder /data $TURBO_PIX_DATA_PATH
COPY --chmod=777 --chown=$USER:$USER --from=builder /empty_dir /tmp

# Copy the built application directly from target directory
COPY --chmod=755 --chown=$USER:$USER --from=builder /app/target/x86_64-unknown-linux-musl/release/turbo-pix /turbo-pix

# Copy ffmpeg and ffprobe static binaries
COPY --chmod=755 --chown=$USER:$USER --from=ffmpeg-downloader /ffmpeg /ffmpeg
COPY --chmod=755 --chown=$USER:$USER --from=ffmpeg-downloader /ffprobe /ffprobe

EXPOSE 18473
USER $USER

ENTRYPOINT ["/turbo-pix"]